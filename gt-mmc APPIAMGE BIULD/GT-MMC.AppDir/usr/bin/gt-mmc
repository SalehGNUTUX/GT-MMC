#!/bin/bash

# GT-MMC v3.1 - GNU Tux Multimedia Converter
LANGUAGE=""
ERROR_FILE="$HOME/.gtmmc_errors.log"

function select_language() {
  if command -v zenity &>/dev/null; then
    choice=$(zenity --list --radiolist --title "Language / Ø§Ù„Ù„ØºØ©" \
      --column "" --column "Language / Ø§Ù„Ù„ØºØ©" \
      TRUE "English" FALSE "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")
  elif command -v kdialog &>/dev/null; then
    choice=$(kdialog --radiolist "Select language / Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©" \
      English "English" on Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© "Arabic" off)
  else
    echo "âŒ zenity Ø£Ùˆ kdialog Ù…Ø·Ù„ÙˆØ¨."
    exit 1
  fi

  [[ "$choice" == "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" ]] && LANGUAGE="ar" || LANGUAGE="en"
}

function t() {
  case "$1" in
    welcome) [[ $LANGUAGE == ar ]] && echo "ğŸ› Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ GT-MMC Ù…Ø­ÙˆÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·" || echo "ğŸ› Welcome to GT-MMC Media Converter" ;;
    choose_type) [[ $LANGUAGE == ar ]] && echo "ğŸ“€ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„:" || echo "ğŸ“€ Choose conversion type:" ;;
    type_video) [[ $LANGUAGE == ar ]] && echo "ØªØ­ÙˆÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ" || echo "Video Conversion" ;;
    type_audio) [[ $LANGUAGE == ar ]] && echo "ØªØ­ÙˆÙŠÙ„ ØµÙˆØª" || echo "Audio Conversion" ;;
    type_image) [[ $LANGUAGE == ar ]] && echo "ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø©" || echo "Image Conversion" ;;
    type_extract_audio) [[ $LANGUAGE == ar ]] && echo "Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØµÙˆØª Ù…Ù† ÙÙŠØ¯ÙŠÙˆ" || echo "Extract Audio from Video" ;;
    quit) [[ $LANGUAGE == ar ]] && echo "âŒ Ø®Ø±ÙˆØ¬" || echo "âŒ Exit" ;;
    choose_format) [[ $LANGUAGE == ar ]] && echo "ğŸ¯ Ø§Ø®ØªØ± Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:" || echo "ğŸ¯ Choose output format:" ;;
    choose_files) [[ $LANGUAGE == ar ]] && echo "ğŸ“‚ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙØ§Øª:" || echo "ğŸ“‚ Select files to convert:" ;;
    choose_folder) [[ $LANGUAGE == ar ]] && echo "ğŸ“ Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­ÙØ¸:" || echo "ğŸ“ Choose output folder:" ;;
    converting) [[ $LANGUAGE == ar ]] && echo "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„..." || echo "ğŸ”„ Converting..." ;;
    done) [[ $LANGUAGE == ar ]] && echo "âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„!" || echo "âœ… Conversion complete!" ;;
    error) [[ $LANGUAGE == ar ]] && echo "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ:" || echo "âŒ Error occurred. Saved to:" ;;
    error_file) echo "$ERROR_FILE" ;;
  esac
}

# Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
select_language
echo "$(t welcome)"

FORMATS_VIDEO=(mp4 mkv avi mov webm)
FORMATS_AUDIO=(mp3 wav ogg aac flac m4a opus)
FORMATS_IMAGE=(png jpg bmp webp gif)

while true; do
  echo
  echo "$(t choose_type)"
  echo "1) $(t type_video)"
  echo "2) $(t type_audio)"
  echo "3) $(t type_image)"
  echo "4) $(t type_extract_audio)"
  echo "0) $(t quit)"
  read -p "> " type_choice

  case "$type_choice" in
    1) mode="video"; formats=("${FORMATS_VIDEO[@]}");;
    2) mode="audio"; formats=("${FORMATS_AUDIO[@]}");;
    3) mode="image"; formats=("${FORMATS_IMAGE[@]}");;
    4) mode="extract_audio"; formats=("${FORMATS_AUDIO[@]}");;
    0) echo "$(t quit) ğŸ‘‹"; exit 0 ;;
    *) echo "âŒ Invalid choice"; continue ;;
  esac

  echo
  echo "$(t choose_format)"
  for i in "${!formats[@]}"; do
    printf "%2d) %s\n" $((i+1)) "${formats[$i]}"
  done
  read -p "> " fchoice
  format="${formats[$((fchoice - 1))]}"

  # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª
  if command -v zenity &>/dev/null; then
    input_files=$(zenity --file-selection --multiple --separator="|" --title "$(t choose_files)")
  elif command -v kdialog &>/dev/null; then
    input_files=$(kdialog --getopenfilename . --multiple --separate-output)
  fi

  IFS='|' read -r -a input_array <<< "$input_files"
  [[ ${#input_array[@]} -eq 0 ]] && echo "âŒ No files selected." && continue

  # Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­ÙØ¸
  if command -v zenity &>/dev/null; then
    output_folder=$(zenity --file-selection --directory --title "$(t choose_folder)")
  elif command -v kdialog &>/dev/null; then
    output_folder=$(kdialog --getexistingdirectory .)
  fi
  [[ -z "$output_folder" ]] && echo "âŒ No folder selected." && continue

  # ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„
  total=${#input_array[@]}
  count=0
  > "$ERROR_FILE"

  (
  for input_file in "${input_array[@]}"; do
    count=$((count + 1))
    base=$(basename "$input_file")
    name="${base%.*}"
    out="$output_folder/$name.$format"

    ffmpeg -y -i "$input_file" "$out" &> /tmp/gtmmc_last.log

    if [[ $? -ne 0 ]]; then
      echo "File: $input_file" >> "$ERROR_FILE"
      cat /tmp/gtmmc_last.log >> "$ERROR_FILE"
      echo "" >> "$ERROR_FILE"
    fi

    progress=$((count * 100 / total))
    echo "# $(t converting): $name"
    echo $progress
  done
  ) | zenity --progress --title="$(t converting)" --percentage=0 --auto-close

  # Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
  if [[ -s "$ERROR_FILE" ]]; then
    notify-send "GT-MMC âŒ" "$(t error) $(t error_file)"
    echo "$(t error) $(t error_file)"
  else
    notify-send "GT-MMC âœ…" "$(t done)"
    echo "$(t done)"
  fi

  echo
  echo "ğŸ” $( [[ $LANGUAGE == ar ]] && echo "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©..." || echo "Returning to main menu..." )"
done
